<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrix Cosmic Life</title>
    <style>
        /* --- 1. BASE STYLES --- */
        body {
            background-color: #050510;
            color: #00f3ff;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #00f3ff;
            background: rgba(0, 243, 255, 0.05);
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.7);
        }

        .lang-switch button {
            font-size: 11px;
            padding: 5px 8px;
            margin-left: 5px;
        }

        /* --- MAIN LAYOUT --- */
        .main-deck {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* --- PANELS (LEFT & RIGHT) --- */
        .panel {
            width: 250px;
            padding: 20px;
            background: rgba(10, 10, 26, 0.95);
            border-right: 1px solid rgba(0, 243, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .panel.right {
            border-right: none;
            border-left: 1px solid rgba(0, 243, 255, 0.3);
        }

        .panel-title {
            font-size: 14px;
            font-weight: bold;
            border-bottom: 2px solid #00f3ff;
            padding-bottom: 5px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .stat-box {
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.7;
            font-size: 11px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 5px #00f3ff;
        }

        .energy-bar-container {
            width: 100%;
            height: 5px;
            background: #333;
            margin-top: 5px;
        }

        .energy-bar {
            height: 100%;
            background: #00f3ff;
            width: 0%;
            box-shadow: 0 0 10px #00f3ff;
            transition: width 0.2s;
        }

        #system-status {
            font-weight: bold;
            margin-top: 5px;
            color: #00ff00;
            font-size: 14px;
        }

        .rule-item,
        .guide-item {
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 8px;
            border-left: 2px solid #0072ff;
            padding-left: 8px;
        }

        .rule-highlight {
            color: #fff;
            font-weight: bold;
        }

        .separator {
            border-top: 1px dashed rgba(0, 243, 255, 0.3);
            margin: 10px 0;
        }

        /* --- VIEWPORT (CENTER GAME) --- */
        .viewport {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #0a0a20 0%, #000 100%);
            position: relative;
            padding: 10px;
        }

        .controls {
            margin-bottom: 15px;
            z-index: 10;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #grid-container {
            display: grid;
            grid-template-columns: repeat(50, 1fr);
            grid-template-rows: repeat(50, 1fr);
            gap: 1px;
            background-color: rgba(0, 243, 255, 0.1);
            border: 1px solid #00f3ff;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.15);
            cursor: crosshair;
            width: min(80vh, 90vw);
            aspect-ratio: 1/1;
            touch-action: none;
        }

        .cell {
            background-color: #0f0f20;
            width: 100%;
            height: 100%;
        }

        .cell.alive {
            background-color: #00f3ff;
            box-shadow: 0 0 5px #00f3ff;
        }

        button {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #00f3ff;
            color: #00f3ff;
            padding: 8px 15px;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            transition: 0.3s;
            font-size: 12px;
        }

        button:hover {
            background: #00f3ff;
            color: #000;
            box-shadow: 0 0 15px #00f3ff;
        }

        button.active {
            background: #00f3ff;
            color: #000;
        }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 900px) {
            body {
                height: auto;
                overflow-y: auto;
            }

            .main-deck {
                flex-direction: column;
                height: auto;
                overflow: visible;
            }

            .viewport {
                order: 1;
                min-height: 60vh;
            }

            .panel.left {
                order: 2;
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #00f3ff;
                box-sizing: border-box;
            }

            .panel.right {
                order: 3;
                width: 100%;
                border-left: none;
                box-sizing: border-box;
            }

            #grid-container {
                width: 95vw;
            }

            h1 {
                font-size: 14px;
            }

            .panel {
                height: auto;
                overflow: visible;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1 id="lbl-project-name">PROJECT: GENESIS</h1>
        <div class="lang-switch">
            <button onclick="setLanguage('vi')" id="btn-vi">VIE</button>
            <button onclick="setLanguage('en')" id="btn-en">ENG</button>
        </div>
    </header>

    <div class="main-deck">
        <aside class="panel left">
            <div class="panel-title" id="lbl-stats-header">STATISTICS</div>

            <div class="stat-box">
                <div class="stat-label">STATUS</div>
                <div id="system-status" style="color: yellow;">STANDBY</div>
            </div>

            <div class="stat-box">
                <div class="stat-label" id="lbl-gen">GENERATION</div>
                <div class="stat-value" id="val-gen">0</div>
            </div>

            <div class="stat-box">
                <div class="stat-label" id="lbl-pop">POPULATION</div>
                <div class="stat-value" id="val-pop">0</div>
                <div class="energy-bar-container">
                    <div class="energy-bar" id="bar-pop"></div>
                </div>
            </div>

            <div class="stat-box">
                <div class="stat-label" id="lbl-peak">PEAK RECORD</div>
                <div class="stat-value" id="val-peak">0</div>
            </div>
        </aside>

        <main class="viewport">
            <div class="controls">
                <button onclick="startGame()" id="btn-start">START</button>
                <button onclick="stopGame()" id="btn-stop">STOP</button>
                <button onclick="randomize()" id="btn-random">CHAOS</button>
                <button onclick="clearGrid()" id="btn-clear">VOID</button>
            </div>
            <div id="grid-container"></div>
        </main>

        <aside class="panel right">
            <div class="panel-title" id="lbl-guide-header">HOW TO PLAY</div>
            <div class="guide-item">
                <span class="rule-highlight" id="g1t">Step 1: Create</span><br>
                <span id="g1d">Draw on grid or click CHAOS.</span>
            </div>
            <div class="guide-item">
                <span class="rule-highlight" id="g2t">Step 2: Run</span><br>
                <span id="g2d">Press START to evolve.</span>
            </div>
            <div class="guide-item">
                <span class="rule-highlight" id="g3t">Step 3: End</span><br>
                <span id="g3d">Auto-stops at extinction.</span>
            </div>

            <div class="separator"></div>
            <div class="panel-title" id="lbl-rules-header">RULES</div>
            <div class="rule-item"><span class="rule-highlight" id="rule-1-title">Lonely:</span> <span id="rule-1-desc">
                    < 2 Die</span>
            </div>
            <div class="rule-item"><span class="rule-highlight" id="rule-2-title">Survival:</span> <span
                    id="rule-2-desc">2-3 Live</span></div>
            <div class="rule-item"><span class="rule-highlight" id="rule-3-title">Crowded:</span> <span
                    id="rule-3-desc">> 3 Die</span></div>
            <div class="rule-item"><span class="rule-highlight" id="rule-4-title">Genesis:</span> <span
                    id="rule-4-desc">3 Reborn</span></div>
        </aside>
    </div>

    <script>
        // --- 1. CONFIG & VARIABLES ---
        const rows = 50; const cols = 50;
        let grid = []; let isRunning = false;
        let generation = 0; let population = 0; let peakPopulation = 0;
        let intervalId = null;
        let isDrawing = false;
        let currentLang = 'vi';

        // --- 2. ONLINE CONFIG (API CỦA BẠN) ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzp6PyejfQ0DPkkOu4dpuPn3fb5jAOXBgirxg5Sd0kT_V920DNyuBbKlswy5VbeMjCf8Q/exec";

        // Tạo Device ID ngẫu nhiên (nếu chưa có)
        let deviceId = localStorage.getItem('gol_device_id');
        if (!deviceId) {
            deviceId = 'Captain-' + Math.floor(Math.random() * 10000);
            localStorage.setItem('gol_device_id', deviceId);
        }

        // --- 3. LANGUAGE DATA ---
        const langData = {
            en: {
                project: "PROJECT: GENESIS", statsHeader: "STATISTICS",
                gen: "GENERATION", pop: "POPULATION", peak: "PEAK RECORD",
                guideHeader: "HOW TO PLAY", rulesHeader: "LOGIC",
                st_run: "RUNNING...", st_stop: "PAUSED", st_die: "EXTINCTION", st_standby: "STANDBY",
                st_sending: "UPLOADING...",
                start: "START", stop: "STOP", random: "CHAOS", clear: "VOID",
                g1t: "1. Create:", g1d: "Touch & Drag to draw life.",
                g2t: "2. Evolve:", g2d: "Press START to run.",
                g3t: "3. End:", g3d: "Auto-stops if empty.",
                r1t: "Lonely:", r1d: "Dies if < 2.",
                r2t: "Survival:", r2d: "Lives if 2-3.",
                r3t: "Crowded:", r3d: "Dies if > 3.",
                r4t: "Genesis:", r4d: "Reborn if 3."
            },
            vi: {
                project: "DỰ ÁN: KHỞI NGUYÊN", statsHeader: "BẢNG ĐIỂM",
                gen: "THẾ HỆ", pop: "DÂN SỐ", peak: "KỶ LỤC",
                guideHeader: "CÁCH CHƠI", rulesHeader: "NGUYÊN TẮC",
                st_run: "ĐANG CHẠY...", st_stop: "TẠM DỪNG", st_die: "TUYỆT CHỦNG", st_standby: "CHỜ LỆNH",
                st_sending: "ĐANG GỬI...",
                start: "CHẠY", stop: "DỪNG", random: "NGẪU NHIÊN", clear: "XÓA BÀN",
                g1t: "1. Gieo mầm:", g1d: "Chạm & Vuốt để vẽ.",
                g2t: "2. Tiến hóa:", g2d: "Bấm CHẠY để xem.",
                g3t: "3. Kết thúc:", g3d: "Tự dừng khi chết hết.",
                r1t: "Cô đơn:", r1d: "Chết nếu < 2.",
                r2t: "Sinh tồn:", r2d: "Sống nếu 2-3.",
                r3t: "Chật chội:", r3d: "Chết nếu > 3.",
                r4t: "Sinh sản:", r4d: "Tái sinh nếu 3."
            }
        };

        const gridContainer = document.getElementById('grid-container');

        // --- 4. INIT & EVENTS ---
        function createGrid() {
            gridContainer.innerHTML = '';
            grid = new Array(rows).fill(null).map(() => new Array(cols).fill(0));

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.id = `cell-${r}-${c}`;
                    // PC Events
                    cell.addEventListener('mousedown', () => { isDrawing = true; toggleCell(r, c); });
                    cell.addEventListener('mouseover', () => { if (isDrawing) toggleCell(r, c, true); });
                    gridContainer.appendChild(cell);
                }
            }

            // MOBILE TOUCH EVENTS
            gridContainer.addEventListener('touchstart', handleTouch, { passive: false });
            gridContainer.addEventListener('touchmove', handleTouch, { passive: false });
            gridContainer.addEventListener('touchend', () => { isDrawing = false; });
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);

            if (target && target.classList.contains('cell')) {
                const parts = target.id.split('-');
                const r = parseInt(parts[1]);
                const c = parseInt(parts[2]);
                toggleCell(r, c, true);
            }
        }

        function toggleCell(r, c, forceOn = false) {
            if (forceOn) {
                if (grid[r][c] === 0) { grid[r][c] = 1; updateUI(); }
            } else {
                grid[r][c] = grid[r][c] ? 0 : 1;
                updateUI();
            }
            updateStats();
        }

        window.addEventListener('mouseup', () => { isDrawing = false; });

        // --- 5. GAME LOGIC ---
        function updateUI() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const cell = document.getElementById(`cell-${r}-${c}`);
                    if (grid[r][c] === 1) cell.classList.add('alive');
                    else cell.classList.remove('alive');
                }
            }
            document.getElementById('val-gen').innerText = generation;
            document.getElementById('val-pop').innerText = population;
            document.getElementById('val-peak').innerText = peakPopulation;
            let percent = Math.min((population / 800) * 100, 100);
            document.getElementById('bar-pop').style.width = percent + '%';
        }

        function updateStats() {
            population = grid.reduce((acc, row) => acc + row.reduce((a, b) => a + b, 0), 0);
            if (population > peakPopulation) peakPopulation = population;
        }

        function computeNextGen() {
            let nextGrid = grid.map(arr => [...arr]);
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    let neighbors = countNeighbors(r, c);
                    let state = grid[r][c];
                    if (state === 0 && neighbors === 3) nextGrid[r][c] = 1;
                    else if (state === 1 && (neighbors < 2 || neighbors > 3)) nextGrid[r][c] = 0;
                    else nextGrid[r][c] = state;
                }
            }
            grid = nextGrid;
            generation++;
            updateStats();
            updateUI();
            checkExtinction();
        }

        function countNeighbors(r, c) {
            let sum = 0;
            for (let i = -1; i < 2; i++) {
                for (let j = -1; j < 2; j++) {
                    let row = (r + i + rows) % rows;
                    let col = (c + j + cols) % cols;
                    sum += grid[row][col];
                }
            }
            sum -= grid[r][c];
            return sum;
        }

        // --- 6. EXTINCTION & SUBMIT SCORE ---
        function checkExtinction() {
            if (population === 0 && isRunning) {
                stopGame();
                submitScore(); // Gọi hàm gửi điểm
            }
        }

        function submitScore() {
            if (peakPopulation < 10) {
                setStatus('st_die', '#ff0000'); // Chết yểu quá thì thôi không gửi
                return;
            }

            // Báo trạng thái đang gửi
            const statusEl = document.getElementById('system-status');
            statusEl.innerText = langData[currentLang].st_sending;
            statusEl.style.color = 'cyan';

            const data = {
                deviceId: deviceId,
                gen: generation,
                pop: peakPopulation
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                console.log("Score Sent!");
                setTimeout(() => {
                    setStatus('st_die', '#ff0000');
                    alert(currentLang === 'vi'
                        ? `Đã lưu kỷ lục của ${deviceId} lên Vũ trụ!`
                        : `Record for ${deviceId} saved to Universe!`);
                }, 1000);
            }).catch(err => {
                console.error("Error:", err);
                setStatus('st_die', '#ff0000');
            });
        }

        // --- 7. CONTROLS ---
        function setStatus(key, color) {
            const el = document.getElementById('system-status');
            if (langData[currentLang][key]) {
                el.innerText = langData[currentLang][key];
            }
            el.style.color = color;
        }

        function startGame() {
            if (!isRunning && population > 0) {
                isRunning = true;
                intervalId = setInterval(computeNextGen, 100);
                document.getElementById('btn-start').classList.add('active');
                document.getElementById('btn-stop').classList.remove('active');
                setStatus('st_run', '#00ff00');
            } else if (population === 0) {
                alert(currentLang === 'vi' ? "Vũ trụ đang trống rỗng!" : "The void is empty!");
            }
        }

        function stopGame() {
            isRunning = false;
            clearInterval(intervalId);
            document.getElementById('btn-start').classList.remove('active');
            document.getElementById('btn-stop').classList.add('active');
            if (population > 0) setStatus('st_stop', 'yellow');
        }

        function clearGrid() {
            stopGame();
            grid = grid.map(row => row.fill(0));
            generation = 0; population = 0;
            updateStats(); updateUI();
            setStatus('st_standby', 'yellow');
        }

        function randomize() {
            stopGame();
            grid = grid.map(row => row.map(() => Math.random() > 0.85 ? 1 : 0));
            generation = 0;
            updateStats(); updateUI();
            setStatus('st_standby', 'yellow');
        }

        function setLanguage(lang) {
            currentLang = lang;
            const d = langData[lang];

            const ids = ['lbl-project-name', 'lbl-stats-header', 'lbl-gen', 'lbl-pop', 'lbl-peak', 'lbl-guide-header', 'lbl-rules-header'];
            const keys = ['project', 'statsHeader', 'gen', 'pop', 'peak', 'guideHeader', 'rulesHeader'];
            ids.forEach((id, i) => document.getElementById(id).innerText = d[keys[i]]);

            document.getElementById('btn-start').innerText = d.start;
            document.getElementById('btn-stop').innerText = d.stop;
            document.getElementById('btn-random').innerText = d.random;
            document.getElementById('btn-clear').innerText = d.clear;

            const list = ['g1t', 'g1d', 'g2t', 'g2d', 'g3t', 'g3d', 'rule-1-title', 'rule-1-desc', 'rule-2-title', 'rule-2-desc', 'rule-3-title', 'rule-3-desc', 'rule-4-title', 'rule-4-desc'];
            const listKeys = ['g1t', 'g1d', 'g2t', 'g2d', 'g3t', 'g3d', 'r1t', 'r1d', 'r2t', 'r2d', 'r3t', 'r3d', 'r4t', 'r4d'];
            list.forEach((id, i) => document.getElementById(id).innerText = d[listKeys[i]]);

            document.getElementById('btn-vi').classList.toggle('active', lang === 'vi');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            if (population === 0) setStatus('st_standby', 'yellow');
        }

        // START
        createGrid();
        randomize();
        setLanguage('vi');
    </script>
</body>

</html>